{"remainingRequest":"/Users/xiangliu/Projects/Web/front-end-notebook/node_modules/vue-loader/lib/index.js??ref--1-1!/Users/xiangliu/Projects/Web/front-end-notebook/node_modules/vuepress/lib/webpack/markdownLoader.js??ref--1-2!/Users/xiangliu/Projects/Web/front-end-notebook/docs/个人心得/前端教程/NodeJs/入门篇/模块机制.md?vue&type=template&id=0d95e95c","dependencies":[{"path":"/Users/xiangliu/Projects/Web/front-end-notebook/docs/个人心得/前端教程/NodeJs/入门篇/模块机制.md","mtime":1536937476242},{"path":"/Users/xiangliu/Projects/Web/front-end-notebook/node_modules/cache-loader/dist/cjs.js","mtime":1532111594974},{"path":"/Users/xiangliu/Projects/Web/front-end-notebook/node_modules/vue-loader/lib/loaders/templateLoader.js","mtime":1532111597631},{"path":"/Users/xiangliu/Projects/Web/front-end-notebook/node_modules/cache-loader/dist/cjs.js","mtime":1532111594974},{"path":"/Users/xiangliu/Projects/Web/front-end-notebook/node_modules/vue-loader/lib/index.js","mtime":1532111597630},{"path":"/Users/xiangliu/Projects/Web/front-end-notebook/node_modules/vuepress/lib/webpack/markdownLoader.js","mtime":1532111597717}],"contextDependencies":[],"result":["\n<div class=\"content\"><h1 id=\"模块机制介绍\"><a class=\"header-anchor\" href=\"#模块机制介绍\" aria-hidden=\"true\">#</a> 模块机制介绍</h1>\n<h2 id=\"什么是模块\"><a class=\"header-anchor\" href=\"#什么是模块\" aria-hidden=\"true\">#</a> 什么是模块?</h2>\n<p>以编程角度来说, &quot;模块&quot; 指的是能够提供一定功能或数据的程序语句集合.  模块具备和外部联系的接口 (其他模块或程序调用该模块的方式)</p>\n<p>在 Node.js 中, 每个\b文件就被视为一个模块.  这个文件可能是 JavaScript \b编写的文件、JSON 或者用 C/C++ 编译的二进制文件.  通过对外接口来向外部暴露功能或者数据, 模块之间可以互相调用.</p>\n<h2 id=\"为什么要用模块\"><a class=\"header-anchor\" href=\"#为什么要用模块\" aria-hidden=\"true\">#</a> 为什么要用模块?</h2>\n<h3 id=\"传统开发模式面临的问题\"><a class=\"header-anchor\" href=\"#传统开发模式面临的问题\" aria-hidden=\"true\">#</a> 传统开发模式面临的问题</h3>\n<p>随着开发复杂度的提升, 将代码都写在一处的传统开发方式, 显现出了很多问题:</p>\n<ul>\n<li><strong>很容易出现代码重复</strong>.  开发人员很容易将一个功能的代码重复地写了好多遍.  这导致了如果日后功能需求出现了变更, 就要有多处代码需要被更改.  随着应用规模的增大, 代码会变得难以维护.</li>\n<li><strong>难以确保代码质量</strong>.  所有代码都混在一起, 实现不同功能的代码全都被写在一个文件中, 使得对于单个功能的独立测试变得困难.</li>\n<li><strong>难以查错</strong>.  所有代码都混在一起, 程序运行出现 BUG 了, 很难快速定位.</li>\n<li><strong>性能浪费</strong>.  因为代码都写在一个文件中, 在只调用文件中一段代码的时候, 也会导致整个文件都加载一遍.  这会使很多根本用不到的代码对性能造成浪费.</li>\n<li><strong>难以多人写协作</strong>.  所有代码都放在一个文件中, 使得多人协作变得困难.  开发人员难以确认其他人做了什么修改, 添加了什么东西.  很容易一个人出了错误, 导致整个程序崩溃.</li>\n<li><strong>等等</strong>...</li>\n</ul>\n<h3 id=\"什么是模块化开发\"><a class=\"header-anchor\" href=\"#什么是模块化开发\" aria-hidden=\"true\">#</a> 什么是模块化开发</h3>\n<p>通过使用模块机制, 我们可以把一个复杂程序的各个功能拆分, 分别封装到不同的模块.  每个模块职责单一 (各管一件事, 之间没交集) 通过开发新模块, 和对已有模块的复用来实现各种功能.  这种开发方式被称为 &quot;模块化开发&quot;.</p>\n<h3 id=\"模块化开发的好处\"><a class=\"header-anchor\" href=\"#模块化开发的好处\" aria-hidden=\"true\">#</a> 模块化开发的好处</h3>\n<p>应用模块化\b开发, 使得各个功能都封装在独立的文件中, 分而治之, 互不干扰.  使得代码易于维护和复用.</p>\n<h2 id=\"commonjs\"><a class=\"header-anchor\" href=\"#commonjs\" aria-hidden=\"true\">#</a> CommonJS</h2>\n<p>Node.js 参照 CommonJS 标准实现了模块机制.  CommonJS 是一套代码规范, 目的是为了构建 JavaScript 在浏览器之外的生态系统 (服务器端, 桌面端).  JavaScript 诞生之初只是为了写网页小脚本, 并不作为开发大型复杂应用的语言, 其自身有很多不足.  并且, 官方规范 (ECMAScript) 制定的时间较早, 涵盖范围较小, 对于后端开发而言, 例如文件系统, I/O 流, 模块系统, 等等方面都没有相应的标准.  基于种种的不足, CommonJS 规范致力于弥补 JavaScript 没有标准的缺陷, 让 JavaScript 有能力去开发复杂应用, 同时具备跨平台能力.</p>\n<h2 id=\"示例\"><a class=\"header-anchor\" href=\"#示例\" aria-hidden=\"true\">#</a> 示例</h2>\n<!--beforebegin--><div class=\"language-js extra-class\"><!--afterbegin--><pre v-pre class=\"language-js\"><code><span class=\"token keyword\">const</span> http <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'http'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">myNodeServer</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    res<span class=\"token punctuation\">.</span><span class=\"token function\">writeHead</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span><span class=\"token string\">'Content-type'</span><span class=\"token punctuation\">:</span><span class=\"token string\">'text/plain'</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    res<span class=\"token punctuation\">.</span><span class=\"token function\">write</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Hello World'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \n    res<span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\nhttp<span class=\"token punctuation\">.</span><span class=\"token function\">createServer</span><span class=\"token punctuation\">(</span>myNodeServer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span><span class=\"token number\">3000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//监听 3000 端口</span>\n\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Server is running!'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \n</code></pre>\n<!--beforeend--></div><!--afterend--><p>上面代码中, 开头通过 <code>require</code> 方法引入了 Node.js 自带的 <code>http</code> 模块.  并用此模块实现了一个 HTTP 服务器.</p>\n<h2 id=\"模块分类\"><a class=\"header-anchor\" href=\"#模块分类\" aria-hidden=\"true\">#</a> 模块分类</h2>\n<p>前文说, 在 Node.js 中, 每个\b文件就被视为一个模块.  这个文件可能是 JavaScript \b编写的文件、JSON 或者用 C/C++ 编译的二进制文件.</p>\n<h3 id=\"核心-原生-模块\"><a class=\"header-anchor\" href=\"#核心-原生-模块\" aria-hidden=\"true\">#</a> 核心(原生)模块</h3>\n<h3 id=\"文件模块\"><a class=\"header-anchor\" href=\"#文件模块\" aria-hidden=\"true\">#</a> 文件模块</h3>\n<h2 id=\"使用模块\"><a class=\"header-anchor\" href=\"#使用模块\" aria-hidden=\"true\">#</a> 使用模块</h2>\n<p>在了解了什么是模块之后, 让我们来看看如何在 Node.js 中实际应用模块机制.  在使用上, 可以很简单的分为三个方面: 创建, 导出, 引入.  先创建一个模块, 然后导出功能或数据, 模块之间可以互相引入导出的内容.</p>\n<p>Node.js 提供了 <code>exports</code> 和 <code>require</code> 两个对象，其中 <code>exports</code> 是模块用于导出的接口, <code>require</code> 用于从外部引入另一个模块, 即获取模块的 <code>exports</code> 对象.</p>\n<h3 id=\"创建-导出模块\"><a class=\"header-anchor\" href=\"#创建-导出模块\" aria-hidden=\"true\">#</a> 创建 &amp; 导出模块</h3>\n<p>先让我们来看看如何创建并把模块的内容导出.  在 Node.js 中, 一个文件就是一个模块.  创建模块的方法就是创建一个文件.</p>\n<p>通过 <code>exports</code> 对象来指定一个模块的导出内容.</p>\n<p>示例:</p>\n<!--beforebegin--><div class=\"language-js extra-class\"><!--afterbegin--><pre v-pre class=\"language-js\"><code><span class=\"token comment\">// 文件名: nameModule.js</span>\n<span class=\"token keyword\">var</span> name <span class=\"token operator\">=</span> <span class=\"token string\">'Garrik'</span><span class=\"token punctuation\">;</span>\n\nexports<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">setName</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>newName<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    name <span class=\"token operator\">=</span> newName<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\nexports<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">getName</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> name<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<!--beforeend--></div><!--afterend--><p>在以上示例中, nameModule.js 文件通过 <code>exports</code> 对象将 <code>setName</code> 和 <code>getName</code> 作为模块的访问接口.  其他的模块可以引入导出的 <code>exports</code> 对象, 直接访问 <code>exports</code> 对象的成员函数.</p>\n<h3 id=\"module-exports-exports\"><a class=\"header-anchor\" href=\"#module-exports-exports\" aria-hidden=\"true\">#</a> module.exports &amp; exports</h3>\n<p>在使用 <code>exports</code> 对象导出内容时, 所有作为对外访问接口的属性和方法都是定义在 <code>exports</code> 属性上的.  上面的例子中 <code>setName</code> 和 <code>getName</code> 方法都直接定义在 <code>exports</code> 对象上.  那如果想直接导出一个对象, 或者基础类型值可不可以呢?</p>\n<p>可能有人会想可不可以这样写:</p>\n<!--beforebegin--><div class=\"language-js extra-class\"><!--afterbegin--><pre v-pre class=\"language-js\"><code><span class=\"token keyword\">var</span> name <span class=\"token operator\">=</span> <span class=\"token string\">'Garrik'</span><span class=\"token punctuation\">;</span>\n\nexports <span class=\"token operator\">=</span> name<span class=\"token punctuation\">;</span>\n</code></pre>\n<!--beforeend--></div><!--afterend--><p>如果你试一下的话会发现, 最后引入的是一个空对象, 而不是你定义在 <code>exports</code> 上的东西.</p>\n<p>在使用 <code>exports</code> \b的时候只能往这个对象里添加新的属性和方法, 而不能对其直接赋值.  如果想直接导出一个对象, 或者基础类型值要使用 <code>module.exports</code> 对象.  例如上面例子就可以改写成:</p>\n<!--beforebegin--><div class=\"language-js extra-class\"><!--afterbegin--><pre v-pre class=\"language-js\"><code><span class=\"token comment\">// 文件名: nameModule.js</span>\n<span class=\"token keyword\">var</span> name <span class=\"token operator\">=</span> <span class=\"token string\">'Garrik'</span><span class=\"token punctuation\">;</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  setName<span class=\"token punctuation\">:</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>newName<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    name <span class=\"token operator\">=</span> newName<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> \n  getName<span class=\"token punctuation\">:</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> name<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span> \n</code></pre>\n<!--beforeend--></div><!--afterend--><p>这样写的话, 就导出了一整个对象, <code>setName</code> 和 <code>getName</code> 方法是这个对象的成员函数.  而不是之前的 <code>exports</code> 对象了.</p>\n<p>除此之外 <code>module.exports</code> 还可以直接导出基础类型值:</p>\n<!--beforebegin--><div class=\"language-js extra-class\"><!--afterbegin--><pre v-pre class=\"language-js\"><code><span class=\"token comment\">// 文件名: numMoule.js</span>\n\n<span class=\"token keyword\">var</span> num <span class=\"token operator\">=</span> <span class=\"token number\">123456</span><span class=\"token punctuation\">;</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> num<span class=\"token punctuation\">;</span>\n</code></pre>\n<!--beforeend--></div><!--afterend--><!--beforebegin--><div class=\"language-js extra-class\"><!--afterbegin--><pre v-pre class=\"language-js\"><code><span class=\"token comment\">// 文件名: showNum.js</span>\n<span class=\"token keyword\">var</span> getNum <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./numModule.js'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// showNum.js 和 numModule.js 在同一目录下</span>\n\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>getNum<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 结果: 123456</span>\n</code></pre>\n<!--beforeend--></div><!--afterend--><p>这种方式下, 导出的就直接是基础类型的值.</p>\n<hr>\n<p>可能还是很多人在疑惑 <code>exports</code> 和 <code>module.exports</code> 区别和关系.</p>\n<p>上面我说, 一个文件被另一个模块引入时, 会被做一些处理.  文件中代码并不被 Node 执行, 而是被打包进一个函数中, 然后 Node 执行这个函数.  打包函数会被传入 <code>exports</code>，<code>require</code>，<code>module</code>，<code>__filename</code>，<code>__dirname</code> 这五个参数.  所有的这些参数都在 Node 执行函数时赋值, 并且只在当前的函数作用域中有效.  打包函数执行到最后, 返回 <code>module.exports</code> 对象.</p>\n<p>其中, <code>exports</code> 是 <code>module.exports</code> 的引用, <code>module</code> 对象代表被打包进去的代码本身.  <code>module</code> 的 <code>exports</code> 对象用于指定一个模块的导出内容.</p>\n<p>在模块中定义外部可访问接口的时候, 有两个方法:</p>\n<!--beforebegin--><div class=\"language-js extra-class\"><!--afterbegin--><pre v-pre class=\"language-js\"><code>exports<span class=\"token punctuation\">.</span>name <span class=\"token operator\">=</span> <span class=\"token string\">'Garrik'</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<!--beforeend--></div><!--afterend--><!--beforebegin--><div class=\"language-js extra-class\"><!--afterbegin--><pre v-pre class=\"language-js\"><code>module<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>name<span class=\"token punctuation\">:</span> <span class=\"token string\">'Garrik'</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<!--beforeend--></div><!--afterend--><p>在使用 <code>exports</code> \b的时候只能往这个对象里添加新的属性和方法, 而不能对其直接赋值.  因为直接赋值会打破其对 <code>module.exports</code> 的引用.</p>\n<!--beforebegin--><div class=\"language-js extra-class\"><!--afterbegin--><pre v-pre class=\"language-js\"><code><span class=\"token comment\">// 这是可以的:</span>\nexports<span class=\"token punctuation\">.</span>name <span class=\"token operator\">=</span> <span class=\"token string\">'Garrik'</span><span class=\"token punctuation\">;</span>\nexports<span class=\"token punctuation\">.</span>gender <span class=\"token operator\">=</span> <span class=\"token string\">'Male'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// 这是不可以的:</span>\nexports <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>name<span class=\"token punctuation\">:</span> <span class=\"token string\">'Garrik'</span><span class=\"token punctuation\">,</span> gender<span class=\"token punctuation\">:</span> <span class=\"token string\">'Male'</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// 应该用 module.exports:</span>\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>name<span class=\"token punctuation\">:</span> <span class=\"token string\">'Garrik'</span><span class=\"token punctuation\">,</span> gender<span class=\"token punctuation\">:</span> <span class=\"token string\">'Male'</span><span class=\"token punctuation\">}</span>\n</code></pre>\n<!--beforeend--></div><!--afterend--><p>如果想直接\b导出一个对象, 或基本类型值, \b应该使用 <code>module.exports</code>.</p>\n<!--beforebegin--><div class=\"language-js extra-class\"><!--afterbegin--><pre v-pre class=\"language-js\"><code><span class=\"token comment\">// 导出函数</span>\nmodule<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">exports</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>num<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> num <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// 导出基本类型值</span>\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token number\">123</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<!--beforeend--></div><!--afterend--><h3 id=\"require\"><a class=\"header-anchor\" href=\"#require\" aria-hidden=\"true\">#</a> require</h3>\n<p>在 Node.js 中, 通过 <code>require</code> 函数来引入外界模块导出的内容.  <code>require</code> 函数接受一个字符串作为路径参数, 函数根据这个字符串参数来进行模块查找. 找到后会返回目标模块导出的 <code>exports</code> 对象.</p>\n<p>示例:</p>\n<!--beforebegin--><div class=\"language-js extra-class\"><!--afterbegin--><pre v-pre class=\"language-js\"><code><span class=\"token comment\">// 文件名: showNameModule.js</span>\n<span class=\"token keyword\">var</span> nameModule <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./nameModule.js'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>nameModule<span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \n<span class=\"token comment\">// 显示: Garrik</span>\n\nnameModule<span class=\"token punctuation\">.</span><span class=\"token function\">setName</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Xiang'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>nameModule<span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// 显示: Xiang</span>\n</code></pre>\n<!--beforeend--></div><!--afterend--><p>上面示例中, 通过 <code>require</code> 引入了当前目录下 nameModule.js 导出的 <code>exports</code> 对象, 并让一个本地变量指向引入模块的 <code>exports</code> 对象.  之后在 showNameModule.js 文件中就可以使用 <code>getName</code> 和 <code>setName</code> 这两个方法了.</p>\n<h2 id=\"包-npm-包管理器\"><a class=\"header-anchor\" href=\"#包-npm-包管理器\" aria-hidden=\"true\">#</a> 包 &amp; NPM 包管理器</h2>\n<h3 id=\"什么是包\"><a class=\"header-anchor\" href=\"#什么是包\" aria-hidden=\"true\">#</a> 什么是包</h3>\n<h3 id=\"什么是包管理器\"><a class=\"header-anchor\" href=\"#什么是包管理器\" aria-hidden=\"true\">#</a> 什么是包管理器</h3>\n<h3 id=\"require-的路径参数\"><a class=\"header-anchor\" href=\"#require-的路径参数\" aria-hidden=\"true\">#</a> require 的路径参数</h3>\n<p>在用 <code>require</code> 引入\b模块时, 路径参数可能有下面\b三种形式:</p>\n<ul>\n<li>相对路径: <code>./</code> 开头 或 <code>../</code> 开头</li>\n<li>绝对路径\b: <code>/</code> 开头</li>\n<li>模块名 (例如: <code>http</code>, <code>fs</code>, <code>url</code>)</li>\n</ul>\n<p>根据参数不同, 加载方式也有区别.</p>\n<p>如果我引入了一个 haha 模块，并没有指定它的路径的话：</p>\n<!--beforebegin--><div class=\"language-js extra-class\"><!--afterbegin--><pre v-pre class=\"language-js\"><code><span class=\"token keyword\">var</span> haha <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'haha'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<!--beforeend--></div><!--afterend--><h4 id=\"无路径-直接模块名\"><a class=\"header-anchor\" href=\"#无路径-直接模块名\" aria-hidden=\"true\">#</a> 无路径, 直接模块名:</h4>\n<h4 id=\"绝对路径-或相对路径\"><a class=\"header-anchor\" href=\"#绝对路径-或相对路径\" aria-hidden=\"true\">#</a> 绝对路径, 或相对路径</h4>\n<h3 id=\"模块查找策略\"><a class=\"header-anchor\" href=\"#模块查找策略\" aria-hidden=\"true\">#</a> 模块查找策略</h3>\n<p>\b前面说 <code>require</code> 函数接受一个字符串作为参数, 函数根据这个字符串参数进行模块查找.  但其具体的内部\b加载步骤是怎么样的呢?</p>\n<p><img src=\"https://i.imgur.com/YSRahKr.jpg\" alt=\"nodejs-require\"></p>\n<p>前面提到了, Node.js 中模块可以分为 原生模块 和 文件模块.  根据模块类型的不同, 加载的优先级也不同.</p>\n<h4 id=\"从文件模块缓存中加载\"><a class=\"header-anchor\" href=\"#从文件模块缓存中加载\" aria-hidden=\"true\">#</a> 从文件模块缓存中加载</h4>\n<p>会先从文件模块的缓存中加载已经存在的模块.</p>\n<h4 id=\"从原生模块加载\"><a class=\"header-anchor\" href=\"#从原生模块加载\" aria-hidden=\"true\">#</a> 从原生模块加载</h4>\n<p>原生模块的优先级仅次于文件模块缓存的优先级.  <code>require</code> 方法在解析文件名之后，优先检查模块是否在原生模块列表中。</p>\n<h4 id=\"从文件加载\"><a class=\"header-anchor\" href=\"#从文件加载\" aria-hidden=\"true\">#</a> 从文件加载</h4>\n<p>当文件模块缓存中不存在，而且不是原生模块的时候，Node.js 会解析 <code>require</code> 方法传入的参数，并从文件系统中加载实际的文件</p>\n<h2 id=\"文件被-require-后发生了什么\"><a class=\"header-anchor\" href=\"#文件被-require-后发生了什么\" aria-hidden=\"true\">#</a> 文件被 require 后发生了什么</h2>\n<p>从 <a href=\"https://github.com/nodejs/node/blob/v5.x/lib/module.js\" target=\"_blank\" rel=\"noopener noreferrer\">lib/module.js<OutboundLink/></a> 代码中分析一个文件被 <code>require</code> 后发生了什么:</p>\n<h3 id=\"require-函数被调用\"><a class=\"header-anchor\" href=\"#require-函数被调用\" aria-hidden=\"true\">#</a> require 函数被调用</h3>\n<!--beforebegin--><div class=\"language-js extra-class\"><!--afterbegin--><pre v-pre class=\"language-js\"><code><span class=\"token comment\">// Loads a module at the given file path. Returns that module's</span>\n<span class=\"token comment\">// `exports` property.</span>\nModule<span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">require</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">assert</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">,</span> <span class=\"token string\">'missing path'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">assert</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> path <span class=\"token operator\">===</span> <span class=\"token string\">'string'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'path must be a string'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> Module<span class=\"token punctuation\">.</span><span class=\"token function\">_load</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">/* isMain */</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<!--beforeend--></div><!--afterend--><p><code>require</code> 函数在执行时会调用 <code>Module._load</code> 函数.</p>\n<h3 id=\"module-load-函数被调用\"><a class=\"header-anchor\" href=\"#module-load-函数被调用\" aria-hidden=\"true\">#</a> Module._load 函数被调用</h3>\n<p><code>Module._load</code> 函数完整代码:</p>\n<!--beforebegin--><div class=\"language-js extra-class\"><!--afterbegin--><pre v-pre class=\"language-js\"><code><span class=\"token comment\">// Check the cache for the requested file. </span>\n<span class=\"token comment\">// 1. If a module already exists in the cache: return its exports object.</span>\n<span class=\"token comment\">// 2. If the module is native: call `NativeModule.require()` with the</span>\n<span class=\"token comment\">//    filename and return the result.</span>\n<span class=\"token comment\">// 3. Otherwise, create a new module for the file and save it to the cache.</span>\n<span class=\"token comment\">//    Then have it load  the file contents before returning its exports</span>\n<span class=\"token comment\">//    object.</span>\nModule<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">_load</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span> parent<span class=\"token punctuation\">,</span> isMain<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>parent<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">debug</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Module._load REQUEST %s parent: %s'</span><span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">,</span> parent<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">var</span> filename <span class=\"token operator\">=</span> Module<span class=\"token punctuation\">.</span><span class=\"token function\">_resolveFilename</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span> parent<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">var</span> cachedModule <span class=\"token operator\">=</span> Module<span class=\"token punctuation\">.</span>_cache<span class=\"token punctuation\">[</span>filename<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>cachedModule<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> cachedModule<span class=\"token punctuation\">.</span>exports<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>NativeModule<span class=\"token punctuation\">.</span><span class=\"token function\">nonInternalExists</span><span class=\"token punctuation\">(</span>filename<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">debug</span><span class=\"token punctuation\">(</span><span class=\"token string\">'load native module %s'</span><span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> NativeModule<span class=\"token punctuation\">.</span><span class=\"token function\">require</span><span class=\"token punctuation\">(</span>filename<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">var</span> module <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Module</span><span class=\"token punctuation\">(</span>filename<span class=\"token punctuation\">,</span> parent<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isMain<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    process<span class=\"token punctuation\">.</span>mainModule <span class=\"token operator\">=</span> module<span class=\"token punctuation\">;</span>\n    module<span class=\"token punctuation\">.</span>id <span class=\"token operator\">=</span> <span class=\"token string\">'.'</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  Module<span class=\"token punctuation\">.</span>_cache<span class=\"token punctuation\">[</span>filename<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> module<span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">var</span> hadException <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    module<span class=\"token punctuation\">.</span><span class=\"token function\">load</span><span class=\"token punctuation\">(</span>filename<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    hadException <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>hadException<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">delete</span> Module<span class=\"token punctuation\">.</span>_cache<span class=\"token punctuation\">[</span>filename<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> module<span class=\"token punctuation\">.</span>exports<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<!--beforeend--></div><!--afterend--><p>下面来一步步的分析 <code>Module._load</code> 函数内都发生了什么.</p>\n<h3 id=\"获取模块完整路径\"><a class=\"header-anchor\" href=\"#获取模块完整路径\" aria-hidden=\"true\">#</a> 获取模块完整路径</h3>\n<p><code>Module._load</code> 函数先调用内部方法 <code>Module._resolveFilename</code>.</p>\n<p><code>Module._resolveFilename</code> 函数完整代码:</p>\n<!--beforebegin--><div class=\"language-js extra-class\"><!--afterbegin--><pre v-pre class=\"language-js\"><code>Module<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">_resolveFilename</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span> parent<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>NativeModule<span class=\"token punctuation\">.</span><span class=\"token function\">nonInternalExists</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> request<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">var</span> resolvedModule <span class=\"token operator\">=</span> Module<span class=\"token punctuation\">.</span><span class=\"token function\">_resolveLookupPaths</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span> parent<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">var</span> id <span class=\"token operator\">=</span> resolvedModule<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">var</span> paths <span class=\"token operator\">=</span> resolvedModule<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// look up the filename first, since that's the cache key.</span>\n  <span class=\"token function\">debug</span><span class=\"token punctuation\">(</span><span class=\"token string\">'looking for %j in %j'</span><span class=\"token punctuation\">,</span> id<span class=\"token punctuation\">,</span> paths<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">var</span> filename <span class=\"token operator\">=</span> Module<span class=\"token punctuation\">.</span><span class=\"token function\">_findPath</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span> paths<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>filename<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">var</span> err <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Cannot find module '\"</span> <span class=\"token operator\">+</span> request <span class=\"token operator\">+</span> <span class=\"token string\">\"'\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    err<span class=\"token punctuation\">.</span>code <span class=\"token operator\">=</span> <span class=\"token string\">'MODULE_NOT_FOUND'</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">throw</span> err<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> filename<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<!--beforeend--></div><!--afterend--><p>可以看到 <code>Module._resolveFilename</code> 函数内进行了一些参数预处理后，最终会调用 <code>Module._findPath</code> 方法，来得到需被导入模块的完整路径</p>\n<p><code>Module._findPath</code> 函数完整代码:</p>\n<!--beforebegin--><div class=\"language-js extra-class\"><!--afterbegin--><pre v-pre class=\"language-js\"><code>Module<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">_findPath</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span> paths<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">.</span><span class=\"token function\">isAbsolute</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    paths <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">''</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// 优先检查缓存</span>\n  <span class=\"token keyword\">var</span> cacheKey <span class=\"token operator\">=</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>request<span class=\"token punctuation\">:</span> request<span class=\"token punctuation\">,</span> paths<span class=\"token punctuation\">:</span> paths<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>Module<span class=\"token punctuation\">.</span>_pathCache<span class=\"token punctuation\">[</span>cacheKey<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> Module<span class=\"token punctuation\">.</span>_pathCache<span class=\"token punctuation\">[</span>cacheKey<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">const</span> exts <span class=\"token operator\">=</span> Object<span class=\"token punctuation\">.</span><span class=\"token function\">keys</span><span class=\"token punctuation\">(</span>Module<span class=\"token punctuation\">.</span>_extensions<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> trailingSlash <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span><span class=\"token function\">slice</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">===</span> <span class=\"token string\">'/'</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// For each path</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">var</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">PL</span> <span class=\"token operator\">=</span> paths<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token constant\">PL</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Don't search further if path doesn't exist</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>paths<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">stat</span><span class=\"token punctuation\">(</span>paths<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">var</span> basePath <span class=\"token operator\">=</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>paths<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">var</span> filename<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>trailingSlash<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> rc <span class=\"token operator\">=</span> <span class=\"token function\">stat</span><span class=\"token punctuation\">(</span>basePath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>rc <span class=\"token operator\">===</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  <span class=\"token comment\">// File. 文件</span>\n        filename <span class=\"token operator\">=</span> <span class=\"token function\">toRealPath</span><span class=\"token punctuation\">(</span>basePath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>rc <span class=\"token operator\">===</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  <span class=\"token comment\">// Directory. 目录</span>\n        filename <span class=\"token operator\">=</span> <span class=\"token function\">tryPackage</span><span class=\"token punctuation\">(</span>basePath<span class=\"token punctuation\">,</span> exts<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>filename<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// try it with each of the extensions </span>\n        <span class=\"token comment\">// 带上 .js .json .node 后缀进行尝试</span>\n        filename <span class=\"token operator\">=</span> <span class=\"token function\">tryExtensions</span><span class=\"token punctuation\">(</span>basePath<span class=\"token punctuation\">,</span> exts<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>filename<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      filename <span class=\"token operator\">=</span> <span class=\"token function\">tryPackage</span><span class=\"token punctuation\">(</span>basePath<span class=\"token punctuation\">,</span> exts<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>filename<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// try it with each of the extensions at \"index\"</span>\n      <span class=\"token comment\">// // 尝试 index.js index.json index.node</span>\n      filename <span class=\"token operator\">=</span> <span class=\"token function\">tryExtensions</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>basePath<span class=\"token punctuation\">,</span> <span class=\"token string\">'index'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> exts<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>filename<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// Warn once if '.' resolved outside the module dir</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>request <span class=\"token operator\">===</span> <span class=\"token string\">'.'</span> <span class=\"token operator\">&amp;&amp;</span> i <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        warned <span class=\"token operator\">=</span> internalUtil<span class=\"token punctuation\">.</span><span class=\"token function\">printDeprecationMessage</span><span class=\"token punctuation\">(</span>\n          <span class=\"token string\">'warning: require(\\'.\\') resolved outside the package '</span> <span class=\"token operator\">+</span>\n          <span class=\"token string\">'directory. This functionality is deprecated and will be removed '</span> <span class=\"token operator\">+</span>\n          <span class=\"token string\">'soon.'</span><span class=\"token punctuation\">,</span> warned<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n\n      Module<span class=\"token punctuation\">.</span>_pathCache<span class=\"token punctuation\">[</span>cacheKey<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> filename<span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">return</span> filename<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<!--beforeend--></div><!--afterend--><p><code>tryPackage</code> 完整代码:</p>\n<!--beforebegin--><div class=\"language-js extra-class\"><!--afterbegin--><pre v-pre class=\"language-js\"><code><span class=\"token keyword\">function</span> <span class=\"token function\">tryPackage</span><span class=\"token punctuation\">(</span>requestPath<span class=\"token punctuation\">,</span> exts<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 获取 package.json 中 main 属性的值</span>\n  <span class=\"token keyword\">var</span> pkg <span class=\"token operator\">=</span> <span class=\"token function\">readPackage</span><span class=\"token punctuation\">(</span>requestPath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>pkg<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">var</span> filename <span class=\"token operator\">=</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>requestPath<span class=\"token punctuation\">,</span> pkg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">tryFile</span><span class=\"token punctuation\">(</span>filename<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token function\">tryExtensions</span><span class=\"token punctuation\">(</span>filename<span class=\"token punctuation\">,</span> exts<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span>\n         <span class=\"token function\">tryExtensions</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>filename<span class=\"token punctuation\">,</span> <span class=\"token string\">'index'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> exts<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<!--beforeend--></div><!--afterend--><p><code>Module._findPath</code> 函数中的路径分析十分清晰:</p>\n<ul>\n<li>若模块的路径不以 <code>/</code> 结尾，则先检查该路径是否真实存在：\n<ul>\n<li>若存在且为一个文件，则直接返回文件路径作为结果。</li>\n<li>若存在且为一个目录，则尝试读取该目录下的 <code>package.json</code> 中 <code>main</code> 属性所指向的文件路径。\n<ul>\n<li>判断该文件路径是否存在，若存在，则直接作为结果返回。</li>\n<li>尝试在该路径后依次加上 <code>.js</code> ， <code>.json</code> 和 <code>.node</code> 后缀，判断是否存在，若存在则返回加上后缀后的路径。</li>\n<li>尝试在该路径后依次加上 <code>index.js</code> ， <code>index.json</code> 和 <code>index.node</code>，判断是否存在，若存在则返回拼接后的路径。</li>\n</ul>\n</li>\n<li>若仍未返回，则为指定的模块路径依次加上 <code>.js</code>, <code>.json</code> 和 <code>.node</code> 后缀，判断是否存在，若存在则返回加上后缀后的路径。\n<ul>\n<li>若模块以 <code>/</code> 结尾，则尝试读取该目录下的 <code>package.json</code> 中 <code>main</code> 属性所指向的文件路径。\n<ul>\n<li>判断该文件路径是否存在，若存在，则直接作为结果返回。</li>\n<li>尝试在该路径后依次加上 .<code>js</code>, .<code>json</code> 和 <code>.node</code> 后缀，判断是否存在，若存在则返回加上后缀后的路径。</li>\n<li>尝试在该路径后依次加上 <code>index.js</code>, <code>index.json</code> 和 <code>index.node</code>，判断是否存在，若存在则返回拼接后的路径。</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>若仍未返回，则为指定的模块路径依次加上 <code>index.js</code>, <code>index.json</code> 和 <code>index.node</code>，判断是否存在，若存在则返回拼接后的路径。</li>\n</ul>\n</li>\n</ul>\n</div>\n",null]}
{"remainingRequest":"/Users/xiangliu/Projects/Web/front-end-notebook/node_modules/vue-loader/lib/index.js??ref--1-1!/Users/xiangliu/Projects/Web/front-end-notebook/node_modules/vuepress/lib/webpack/markdownLoader.js??ref--1-2!/Users/xiangliu/Projects/Web/front-end-notebook/docs/nodejs/Express/基础知识/中间件.md?vue&type=template&id=84ca0286","dependencies":[{"path":"/Users/xiangliu/Projects/Web/front-end-notebook/docs/nodejs/Express/基础知识/中间件.md","mtime":1532313468113},{"path":"/Users/xiangliu/Projects/Web/front-end-notebook/node_modules/cache-loader/dist/cjs.js","mtime":1532111594974},{"path":"/Users/xiangliu/Projects/Web/front-end-notebook/node_modules/vue-loader/lib/loaders/templateLoader.js","mtime":1532111597631},{"path":"/Users/xiangliu/Projects/Web/front-end-notebook/node_modules/cache-loader/dist/cjs.js","mtime":1532111594974},{"path":"/Users/xiangliu/Projects/Web/front-end-notebook/node_modules/vue-loader/lib/index.js","mtime":1532111597630},{"path":"/Users/xiangliu/Projects/Web/front-end-notebook/node_modules/vuepress/lib/webpack/markdownLoader.js","mtime":1532111597717}],"contextDependencies":[],"result":["\n<div class=\"content\"><h1 id=\"中间件\"><a class=\"header-anchor\" href=\"#中间件\" aria-hidden=\"true\">#</a> 中间件</h1>\n<p><a href=\"http://www.expressjs.com.cn/guide/using-middleware.html\" target=\"_blank\" rel=\"noopener noreferrer\">Express文档链接<OutboundLink/></a></p>\n<h2 id=\"概念\"><a class=\"header-anchor\" href=\"#概念\" aria-hidden=\"true\">#</a> 概念</h2>\n<p>如果只用一个大函数来处理请求，随着项目的增大，这个函数会变得越来越难维护。\n使用中间件，来把这个大函数来分解成多个小函数，一次只处理一件事。</p>\n<p>从概念上讲，中间件是一种功能的封装方式。具体来说就是封装在程序中处理 HTTP 请求的功能。</p>\n<p>在使用上讲，中间件只是一个有 3 个参数的函数: 一个 请求对象、一个 响应对象 和一个 next 函数。\n(还有一种 4 个参数的形式，用来做错误处理）</p>\n<p>可以把中间件想象成 水管。水从一端入，在到达出水口的过程中，会经历各种 仪表 和 阀门。而这个过程中最重要的就是顺序。在其中一个阀门中注入一种原料，流过这个阀门之后的水都会含有这种原料。</p>\n<p>在 Express 程序中，通过调用 <code>app.use</code> 向管道中插入中间件。</p>\n<p>由传入每个中间件的 next函数 控制在 “管道” 中的请求是否终止向下传。调用 next() 方法将控制权交给下一个中间件，否则请求就会挂起。</p>\n<p><img src=\"https://i.imgur.com/MVC9SgG.png\" alt=\"Screen Shot 2018-07-08 at 5.03.52 PM\"></p>\n<p><img src=\"https://i.imgur.com/Uba2gsE.png\" alt=\"Screen Shot 2018-07-08 at 5.05.47 PM\"></p>\n<p>\b在 Node 中，req 和 res 只作为一个\b\b回调函数的参数。\n但在 Express 中，req 和 res 传递到一个 回调函数\b组（middleware stack）从前到后执行。</p>\n<h2 id=\"中间件-和-路由处理器\"><a class=\"header-anchor\" href=\"#中间件-和-路由处理器\" aria-hidden=\"true\">#</a> 中间件 和 路由处理器</h2>\n<p>路由处理器（<code>app.get</code>，<code>app.post</code>，被统称为 <code>app.VERB</code>）可以被看作只处理特定 HTTP 请求的中间件。\n可以将 <code>app.use</code> 看作可以处理全部 HTTP 请求的路由处理器。(基本上等同于 <code>app.all</code>）</p>\n<!--beforebegin--><div class=\"language-js extra-class\"><!--afterbegin--><pre v-pre class=\"language-js\"><code>app<span class=\"token punctuation\">.</span><span class=\"token keyword\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  res<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token string\">'GET request to the homepage'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<!--beforeend--></div><!--afterend--><p>路由处理器的第一个参数必须是路径。</p>\n<!--beforebegin--><div class=\"language-js extra-class\"><!--afterbegin--><pre v-pre class=\"language-js\"><code><span class=\"token comment\">// 没有挂载路径的中间件，应用的每个请求都会执行该中间件</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">,</span> next<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Time:'</span><span class=\"token punctuation\">,</span> Date<span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// 挂载至 /user/:id 的中间件，任何指向 /user/:id 的请求都会执行它</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/user/:id'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">,</span> next<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Request Type:'</span><span class=\"token punctuation\">,</span> req<span class=\"token punctuation\">.</span>method<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<!--beforeend--></div><!--afterend--><p>中间件也可以将路径作为第一个参数，但它是可选的(如果忽略这个参数，它会匹配所 有路径)。\n路由处理器和中间件的参数中都有回调函数，这个函数有 2 个、3 个或 4 个参数。</p>\n<ul>\n<li>\n<p>如果有 2 个或 3 个参数，头两 个参数是 请求 和 响应对象，第三个参数是 next 函数。</p>\n</li>\n<li>\n<p>如果有 4 个参数，它就变成了 错误处理中间件，第一个参数变成了 error 对象，然后依次是 请求、响应 和 next 对象。</p>\n</li>\n</ul>\n<p>如果不调用 <code>next()</code>，请求会被挂起，也不会再有处理器或中间件做后续处理。\n如果你不调用 <code>next()</code>，则应该发送一个响应到客户端(<code>res.send</code>、<code>res.json</code>、<code>res.render</code> 等)\n如果你不这样做，请求会被挂起并最终导致超时。</p>\n<p>如果调用了 <code>next()</code>，一般就不要发送响应到客户端。如果你发送了，管道中后续的 中间件 或 路由处理器 还会执行，但它们发送的任何响应都会被忽略。</p>\n<h2 id=\"常用中间件\"><a class=\"header-anchor\" href=\"#常用中间件\" aria-hidden=\"true\">#</a> 常用中间件</h2>\n<p><code>express.static(root, [options])</code></p>\n<p>express.static 是 Express 唯一内置的中间件。负责在 Express 应用中托管静态资源。基于 <a href=\"https://github.com/expressjs/serve-static\" target=\"_blank\" rel=\"noopener noreferrer\">serve-static<OutboundLink/></a></p>\n<p>参数 <code>root</code> 指提供静态资源的根目录。</p>\n<p>其余常用中间件 <a href=\"http://www.expressjs.com.cn/resources/middleware.html\" target=\"_blank\" rel=\"noopener noreferrer\">参考文档<OutboundLink/></a></p>\n</div>\n",null]}
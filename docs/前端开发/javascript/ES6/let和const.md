# let å’Œ const å‘½ä»¤

## let

[æ–‡æ¡£ - MDN](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Statements/let)

`let` å‘½ä»¤ï¼Œç”¨æ¥å£°æ˜å˜é‡ã€‚å®ƒçš„ç”¨æ³•ç±»ä¼¼äº `var`.  `let` å£°æ˜çš„å˜é‡åªåœ¨å®ƒæ‰€åœ¨çš„ä»£ç å—æœ‰æ•ˆã€‚


``` js
// åœ¨ for å¾ªç¯ä¸­, let å£°æ˜çš„ i, åœ¨å¾ªç¯å¤–æ‰¾ä¸åˆ°

for (let i = 0; i < 10; i++) {
  // ...
}

console.log(i);
// ReferenceError: i is not defined
```

### ä¸å­˜åœ¨å˜é‡æå‡ 

`var` å‘½ä»¤ä¼šå‘ç”Ÿ â€å˜é‡æå‡â€œ ç°è±¡ï¼Œå³å˜é‡å¯ä»¥åœ¨å£°æ˜ä¹‹å‰ä½¿ç”¨ï¼Œå€¼ä¸º `undefined`

`let` æ‰€å£°æ˜çš„å˜é‡ä¸€å®šè¦åœ¨å£°æ˜åä½¿ç”¨ï¼Œå¦åˆ™æŠ¥é”™ã€‚

``` js
// var çš„æƒ…å†µ
console.log(foo); // è¾“å‡ºundefined
var foo = 2;

// let çš„æƒ…å†µ
console.log(bar); // æŠ¥é”™ReferenceError
let bar = 2;
```

### æš‚æ—¶æ€§æ­»åŒº

åªè¦å—çº§ä½œç”¨åŸŸå†…å­˜åœ¨ `let` å‘½ä»¤ï¼Œå®ƒæ‰€å£°æ˜çš„å˜é‡å°±â€œç»‘å®šâ€ï¼ˆbindingï¼‰è¿™ä¸ªåŒºåŸŸï¼Œä¸å†å—å¤–éƒ¨çš„å½±å“ã€‚

``` js
var tmp = 123;

if (true) {
  tmp = 'abc'; // ReferenceError
  let tmp;
}
```

ä¸Šé¢ä»£ç ä¸­ï¼Œå­˜åœ¨å…¨å±€å˜é‡ `tmp`ï¼Œä½†æ˜¯å—çº§ä½œç”¨åŸŸå†… `let` åˆå£°æ˜äº†ä¸€ä¸ªå±€éƒ¨å˜é‡ `tmp`ï¼Œå¯¼è‡´åè€…ç»‘å®šè¿™ä¸ªå—çº§ä½œç”¨åŸŸï¼Œæ‰€ä»¥åœ¨ `let` å£°æ˜å˜é‡å‰ï¼Œå¯¹ `tmp` èµ‹å€¼ä¼šæŠ¥é”™ã€‚

åœ¨ä»£ç å—å†…ï¼Œä½¿ç”¨ `let` å‘½ä»¤å£°æ˜å˜é‡ä¹‹å‰ï¼Œè¯¥å˜é‡éƒ½æ˜¯ä¸å¯ç”¨çš„ã€‚è¿™åœ¨è¯­æ³•ä¸Šï¼Œç§°ä¸º â€œæš‚æ—¶æ€§æ­»åŒºâ€ï¼ˆtemporal dead zoneï¼Œç®€ç§° TDZï¼‰ã€‚

ğŸŒ° çœ‹çœ‹ä¸‹é¢è¿™æ®µä»£ç é—®é¢˜å‡ºåœ¨å“ª?

``` js
function bar(x = y, y = 2) {
  return [x, y];
}

bar(); // æŠ¥é”™
```

ä¸Šé¢ä»£ç ä¸­ï¼Œè°ƒç”¨ `bar` å‡½æ•°ä¹‹æ‰€ä»¥æŠ¥é”™ï¼ˆæŸäº›å®ç°å¯èƒ½ä¸æŠ¥é”™ï¼‰ï¼Œæ˜¯å› ä¸ºå‚æ•° `x` é»˜è®¤å€¼ç­‰äºå¦ä¸€ä¸ªå‚æ•° `y`ï¼Œè€Œæ­¤æ—¶ `y` è¿˜æ²¡æœ‰å£°æ˜ï¼Œå±äºâ€æ­»åŒºâ€œã€‚å¦‚æœ `y` çš„é»˜è®¤å€¼æ˜¯ `x`ï¼Œå°±ä¸ä¼šæŠ¥é”™ï¼Œå› ä¸ºæ­¤æ—¶ `x` å·²ç»å£°æ˜äº†ã€‚

### ä¸å…è®¸é‡å¤å£°æ˜ 

`let` ä¸å…è®¸åœ¨ç›¸åŒä½œç”¨åŸŸå†…ï¼Œé‡å¤å£°æ˜åŒä¸€ä¸ªå˜é‡ã€‚

``` js
// æŠ¥é”™
function func() {
  let a = 10;
  var a = 1;
}

// æŠ¥é”™
function func() {
  let a = 10;
  let a = 1;
}

function func(arg) {
  let arg; // æŠ¥é”™
}
```

### ES5 æ²¡æœ‰å—çº§ä½œç”¨åŸŸ

ES5 åªæœ‰å…¨å±€ä½œç”¨åŸŸå’Œå‡½æ•°ä½œç”¨åŸŸï¼Œæ²¡æœ‰å—çº§ä½œç”¨åŸŸï¼Œè¿™å¸¦æ¥å¾ˆå¤šä¸åˆç†çš„åœºæ™¯ã€‚

#### å†…å±‚å˜é‡è¦†ç›–å¤–å±‚å˜é‡

å˜é‡æå‡ï¼Œå¯¼è‡´å†…å±‚çš„ `tmp` å˜é‡è¦†ç›–äº†å¤–å±‚çš„ `tmp` å˜é‡ã€‚

``` js
var tmp = new Date();

function f() {
  console.log(tmp);
  if (false) {
    var tmp = 'hello world';
  }
}

f(); // undefined
```

#### è®¡æ•°çš„å¾ªç¯å˜é‡æ³„éœ²ä¸ºå…¨å±€å˜é‡

``` js
var s = 'hello';

for (var i = 0; i < s.length; i++) {
  console.log(s[i]);
}

console.log(i); // 5
```

### ES6 çš„å—çº§ä½œç”¨åŸŸ

`let` å®é™…ä¸Šè®© JavaScript å®ç°äº†å—çº§ä½œç”¨åŸŸã€‚

``` js
function f1() {
  let n = 5;
  if (true) {
    let n = 10;
  }
  console.log(n); // 5
}
```

å—çº§ä½œç”¨åŸŸçš„å‡ºç°ï¼Œå®é™…ä¸Šä½¿å¾—ç”¨**ç«‹å³æ‰§è¡Œå‡½æ•°è¡¨è¾¾å¼**ï¼ˆIIFEï¼‰æ¥æ„å»ºå‡½æ•°ä½œç”¨åŸŸå˜å¾—ä¸å†å¿…è¦äº†ã€‚

``` js
// IIFE å†™æ³•
(function () {
  var tmp = ...;
  ...
}());

// å—çº§ä½œç”¨åŸŸå†™æ³•
{
  let tmp = ...;
  ...
}
```

### å—çº§ä½œç”¨åŸŸ ä¸ å‡½æ•°å£°æ˜ 

å‡½æ•°èƒ½ä¸èƒ½åœ¨å—çº§ä½œç”¨åŸŸä¹‹ä¸­å£°æ˜ï¼Ÿè¿™æ˜¯ä¸€ä¸ªç›¸å½“ä»¤äººæ··æ·†çš„é—®é¢˜ã€‚

ES5 è§„å®šï¼Œå‡½æ•°åªèƒ½åœ¨é¡¶å±‚ä½œç”¨åŸŸå’Œå‡½æ•°ä½œç”¨åŸŸä¹‹ä¸­å£°æ˜ï¼Œä¸èƒ½åœ¨å—çº§ä½œç”¨åŸŸå£°æ˜ã€‚ä½†æ˜¯äº‹å®ä¸Š, å„å®¶æµè§ˆå™¨éƒ½å…è®¸åœ¨å—çº§ä½œç”¨åŸŸä¹‹ä¸­å£°æ˜å‡½æ•°.

ES6 å¼•å…¥äº†å—çº§ä½œç”¨åŸŸï¼Œæ˜ç¡®å…è®¸åœ¨å—çº§ä½œç”¨åŸŸä¹‹ä¸­å£°æ˜å‡½æ•°ã€‚ES6 è§„å®šï¼Œå—çº§ä½œç”¨åŸŸä¹‹ä¸­ï¼Œå‡½æ•°å£°æ˜è¯­å¥çš„è¡Œä¸ºç±»ä¼¼äº `let`ï¼Œ**åœ¨å—çº§ä½œç”¨åŸŸä¹‹å¤–ä¸å¯å¼•ç”¨**ã€‚

``` js
// ES5 ç¯å¢ƒ
function f() { console.log('I am outside!'); }

(function () {
  if (false) {
      function f() { console.log('I am inside!'); }
  }
  f();
}());
```

ä¸Šé¢çš„ä»£ç , åœ¨ ES5 ä¸­è¿è¡Œï¼Œä¼šå¾—åˆ° â€œI am inside!â€.  åœ¨ ES6 ä¸­è¿è¡Œç†è®ºä¸Šä¼šå¾—åˆ° â€œI am outside!â€ ä½†å®é™…ä¸Šåœ¨ ES6 æµè§ˆå™¨ä¸­è¿è¡Œä¸€ä¸‹ä¸Šé¢çš„ä»£ç ï¼Œæ˜¯å¯èƒ½ä¼šæŠ¥é”™çš„.

ä¸ºäº†å…¼å®¹è€ä»£ç , æµè§ˆå™¨çš„å®ç°å¯ä»¥ä¸éµå®ˆ ES6 çš„è§„å®š.

* å…è®¸åœ¨å—çº§ä½œç”¨åŸŸå†…å£°æ˜å‡½æ•°ã€‚
* å‡½æ•°å£°æ˜ç±»ä¼¼äºvarï¼Œå³ä¼šæå‡åˆ°å…¨å±€ä½œç”¨åŸŸæˆ–å‡½æ•°ä½œç”¨åŸŸçš„å¤´éƒ¨ã€‚
* åŒæ—¶ï¼Œå‡½æ•°å£°æ˜è¿˜ä¼šæå‡åˆ°æ‰€åœ¨çš„å—çº§ä½œç”¨åŸŸçš„å¤´éƒ¨ã€‚

æ‰€ä»¥æˆ‘ä»¬åº”åœ¨å—çº§ä½œç”¨åŸŸä¸­å†™å‡½æ•°è¡¨è¾¾å¼ï¼Œè€Œä¸æ˜¯å‡½æ•°å£°æ˜è¯­å¥.

é¡ºä¾¿ä¸€æ, ES6 çš„å—çº§ä½œç”¨åŸŸå…è®¸å£°æ˜å‡½æ•°çš„è§„åˆ™ï¼Œåªåœ¨ä½¿ç”¨å¤§æ‹¬å·çš„æƒ…å†µä¸‹æˆç«‹ï¼Œå¦‚æœæ²¡æœ‰ä½¿ç”¨å¤§æ‹¬å·ï¼Œå°±ä¼šæŠ¥é”™ã€‚

``` js
// ä¸æŠ¥é”™
'use strict';
if (true) {
  function f() {}
}

// æŠ¥é”™
'use strict';
if (true)
  function f() {}
```

## const

[æ–‡æ¡£ - MDN](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Statements/const)

`const` å£°æ˜ä¸€ä¸ªåªè¯»çš„å¸¸é‡ã€‚ä¸€æ—¦å£°æ˜ï¼Œå¸¸é‡çš„å€¼å°±ä¸èƒ½æ”¹å˜ã€‚è¿™æ„å‘³ç€ï¼Œ`const` ä¸€æ—¦å£°æ˜å˜é‡ï¼Œå°±å¿…é¡»ç«‹å³åˆå§‹åŒ–

`const` å‘½ä»¤å£°æ˜çš„å¸¸é‡ä¹Ÿæ˜¯ä¸æå‡ï¼ŒåŒæ ·å­˜åœ¨æš‚æ—¶æ€§æ­»åŒºï¼Œåªèƒ½åœ¨å£°æ˜çš„ä½ç½®åé¢ä½¿ç”¨ã€‚

`const` çš„ä½œç”¨åŸŸä¸ `let` å‘½ä»¤ç›¸åŒï¼šåªåœ¨å£°æ˜æ‰€åœ¨çš„å—çº§ä½œç”¨åŸŸå†…æœ‰æ•ˆã€‚

`const` å£°æ˜çš„å¸¸é‡ï¼Œä¹Ÿä¸ `let` ä¸€æ ·ä¸å¯é‡å¤å£°æ˜ã€‚

``` js
const PI = 3.1415;
PI // 3.1415

PI = 3;
// TypeError: Assignment to constant variable.
```

`const` å®é™…ä¸Šä¿è¯çš„ï¼Œå¹¶ä¸æ˜¯å˜é‡çš„å€¼ä¸å¾—æ”¹åŠ¨ï¼Œè€Œæ˜¯**å˜é‡æŒ‡å‘çš„é‚£ä¸ªå†…å­˜åœ°å€æ‰€ä¿å­˜çš„æ•°æ®ä¸å¾—æ”¹åŠ¨**ã€‚

å¯¹äºç®€å•ç±»å‹çš„æ•°æ®ï¼ˆæ•°å€¼ã€å­—ç¬¦ä¸²ã€å¸ƒå°”å€¼ï¼‰ï¼Œå€¼å°±ä¿å­˜åœ¨å˜é‡æŒ‡å‘çš„é‚£ä¸ªå†…å­˜åœ°å€ï¼Œå› æ­¤ç­‰åŒäºå¸¸é‡ã€‚ä½†å¯¹äºå¤åˆç±»å‹çš„æ•°æ®ï¼ˆä¸»è¦æ˜¯å¯¹è±¡å’Œæ•°ç»„ï¼‰ï¼Œå˜é‡æŒ‡å‘çš„å†…å­˜åœ°å€ï¼Œä¿å­˜çš„åªæ˜¯ä¸€ä¸ªæŒ‡å‘å®é™…æ•°æ®çš„æŒ‡é’ˆï¼Œ`const` åªèƒ½ä¿è¯è¿™ä¸ªæŒ‡é’ˆæ˜¯å›ºå®šçš„ï¼ˆå³æ€»æ˜¯æŒ‡å‘å¦ä¸€ä¸ªå›ºå®šçš„åœ°å€ï¼‰

### [é¢˜å¤–è¯] é¡¶å±‚å¯¹è±¡çš„å±æ€§

é¡¶å±‚å¯¹è±¡ï¼Œåœ¨æµè§ˆå™¨ç¯å¢ƒæŒ‡çš„æ˜¯ `window` å¯¹è±¡ï¼Œåœ¨ Node æŒ‡çš„æ˜¯ `global` å¯¹è±¡ã€‚ES5 ä¹‹ä¸­ï¼Œ**é¡¶å±‚å¯¹è±¡çš„å±æ€§ ä¸ å…¨å±€å˜é‡ æ˜¯ç­‰ä»·çš„**ã€‚

``` js
window.a = 1;
a // 1

a = 2;
window.a // 2
```

é¡¶å±‚å¯¹è±¡çš„å±æ€§ä¸å…¨å±€å˜é‡æŒ‚é’©ï¼Œè¢«è®¤ä¸ºæ˜¯ JavaScript è¯­è¨€æœ€å¤§çš„è®¾è®¡è´¥ç¬”ä¹‹ä¸€ã€‚

è¿™æ ·çš„è®¾è®¡å¸¦æ¥äº†å‡ ä¸ªå¾ˆå¤§çš„é—®é¢˜:
* é¦–å…ˆ, æ˜¯æ²¡æ³•åœ¨ç¼–è¯‘æ—¶å°±æŠ¥å‡ºå˜é‡æœªå£°æ˜çš„é”™è¯¯ï¼Œåªæœ‰è¿è¡Œæ—¶æ‰èƒ½çŸ¥é“ï¼ˆå› ä¸ºå…¨å±€å˜é‡å¯èƒ½æ˜¯é¡¶å±‚å¯¹è±¡çš„å±æ€§åˆ›é€ çš„ï¼Œè€Œå±æ€§çš„åˆ›é€ æ˜¯åŠ¨æ€çš„ï¼‰
* å…¶æ¬¡, ç¨‹åºå‘˜å¾ˆå®¹æ˜“ä¸çŸ¥ä¸è§‰åœ°å°±åˆ›å»ºäº†å…¨å±€å˜é‡ï¼ˆæ¯”å¦‚æ‰“å­—å‡ºé”™)
* æœ€å, é¡¶å±‚å¯¹è±¡çš„å±æ€§æ˜¯åˆ°å¤„å¯ä»¥è¯»å†™çš„ï¼Œè¿™éå¸¸ä¸åˆ©äºæ¨¡å—åŒ–ç¼–ç¨‹

å¦ä¸€æ–¹é¢ï¼Œ`window` å¯¹è±¡æœ‰å®ä½“å«ä¹‰ï¼ŒæŒ‡çš„æ˜¯æµè§ˆå™¨çš„çª—å£å¯¹è±¡ï¼Œé¡¶å±‚å¯¹è±¡æ˜¯ä¸€ä¸ªæœ‰å®ä½“å«ä¹‰çš„å¯¹è±¡ï¼Œä¹Ÿæ˜¯ä¸åˆé€‚çš„ã€‚

ES6 ä¸ºäº†æ”¹å˜è¿™ä¸€ç‚¹ï¼Œä¸€æ–¹é¢è§„å®šï¼Œä¸ºäº†ä¿æŒå…¼å®¹æ€§ï¼Œ`var` å‘½ä»¤å’Œ `function` å‘½ä»¤å£°æ˜çš„å…¨å±€å˜é‡ï¼Œä¾æ—§æ˜¯é¡¶å±‚å¯¹è±¡çš„å±æ€§ï¼›å¦ä¸€æ–¹é¢è§„å®šï¼Œ`let` å‘½ä»¤ã€`const` å‘½ä»¤ã€`class` å‘½ä»¤å£°æ˜çš„å…¨å±€å˜é‡ï¼Œä¸å±äºé¡¶å±‚å¯¹è±¡çš„å±æ€§ã€‚

### [é¢˜å¤–è¯] global å¯¹è±¡

ES5 çš„é¡¶å±‚å¯¹è±¡ï¼Œæœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªé—®é¢˜ï¼Œå› ä¸ºå®ƒåœ¨å„ç§å®ç°é‡Œé¢æ˜¯ä¸ç»Ÿä¸€çš„ã€‚
* æµè§ˆå™¨é‡Œé¢ï¼Œé¡¶å±‚å¯¹è±¡æ˜¯ `window`ï¼Œä½† Node å’Œ Web Worker æ²¡æœ‰ `window`ã€‚
* æµè§ˆå™¨å’Œ Web Worker é‡Œé¢ï¼Œ`self` ä¹ŸæŒ‡å‘é¡¶å±‚å¯¹è±¡ï¼Œä½†æ˜¯ Node æ²¡æœ‰ `self`ã€‚
* Node é‡Œé¢ï¼Œé¡¶å±‚å¯¹è±¡æ˜¯ `global`ï¼Œä½†å…¶ä»–ç¯å¢ƒéƒ½ä¸æ”¯æŒã€‚

ä¸ºäº†åŒä¸€æ®µä»£ç ä¸ºäº†èƒ½å¤Ÿåœ¨å„ç§ç¯å¢ƒï¼Œéƒ½èƒ½å–åˆ°é¡¶å±‚å¯¹è±¡ï¼Œç°åœ¨ä¸€èˆ¬æ˜¯ä½¿ç”¨ `this` å˜é‡ï¼Œä½†æ˜¯æœ‰å±€é™æ€§ã€‚

* å…¨å±€ç¯å¢ƒä¸­ï¼Œ`this` ä¼šè¿”å›é¡¶å±‚å¯¹è±¡ã€‚ä½†æ˜¯ï¼ŒNode æ¨¡å—å’Œ ES6 æ¨¡å—ä¸­ï¼Œ`this` è¿”å›çš„æ˜¯å½“å‰æ¨¡å—ã€‚
* å‡½æ•°é‡Œé¢çš„ `this`ï¼Œå¦‚æœå‡½æ•°ä¸æ˜¯ä½œä¸ºå¯¹è±¡çš„æ–¹æ³•è¿è¡Œï¼Œè€Œæ˜¯å•çº¯ä½œä¸ºå‡½æ•°è¿è¡Œï¼Œ`this` ä¼šæŒ‡å‘é¡¶å±‚å¯¹è±¡ã€‚ä½†æ˜¯ï¼Œä¸¥æ ¼æ¨¡å¼ä¸‹ï¼Œè¿™æ—¶ `this` ä¼šè¿”å› `undefined`ã€‚
* ä¸ç®¡æ˜¯ä¸¥æ ¼æ¨¡å¼ï¼Œè¿˜æ˜¯æ™®é€šæ¨¡å¼ï¼Œ`new Function('return this')()`ï¼Œæ€»æ˜¯ä¼šè¿”å›å…¨å±€å¯¹è±¡ã€‚ä½†æ˜¯ï¼Œå¦‚æœæµè§ˆå™¨ç”¨äº† CSPï¼ˆContent Security Policyï¼Œå†…å®¹å®‰å…¨ç­–ç•¥ï¼‰ï¼Œé‚£ä¹ˆ `eval`ã€`new Function` è¿™äº›æ–¹æ³•éƒ½å¯èƒ½æ— æ³•ä½¿ç”¨ã€‚

é‚£ä¹ˆå¾ˆéš¾æ‰¾åˆ°ä¸€ç§æ–¹æ³•ï¼Œ**å¯ä»¥åœ¨æ‰€æœ‰æƒ…å†µä¸‹ï¼Œéƒ½å–åˆ°é¡¶å±‚å¯¹è±¡**.  ä¸‹é¢æ˜¯ä¸¤ç§å‹‰å¼ºå¯ä»¥ä½¿ç”¨çš„æ–¹æ³•:

``` js
(typeof window !== 'undefined'
   ? window
   : (typeof process === 'object' &&
      typeof require === 'function' &&
      typeof global === 'object')
     ? global
     : this);

// æ–¹æ³•äºŒ
var getGlobal = function () {
  if (typeof self !== 'undefined') { return self; }
  if (typeof window !== 'undefined') { return window; }
  if (typeof global !== 'undefined') { return global; }
  throw new Error('unable to locate global object');
};
```

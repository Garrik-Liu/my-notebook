# 搭建静态资源服务器

在上一章, 我们搭建了一个非常简单的 "Hello World" 服务器.  在这一章里, 我们要继续上一章所学的知识, 进一步尝试搭建, 提供静态资源的服务器.

## 什么是静态资源服务器?

那先说什么是 **静态资源**, 它指的是不会被服务器的动态运行所改变或者生成的文件.  它最初在服务器运行之前是什么样子, 到服务器结束运行时, 它还是那个样子.  比如平时写的 `js`, `css`, `html` 文件, 都可以算是静态资源.  那么很容易理解, 静态资源服务器的功能就是向客户端提供静态资源.  

话不多说, 开始写代码:

首先我们知道, 它先是一个 "服务器".  那根据上一章的所学, 我们要先用 `http` 模块创建一个 HTTP 服务器.

``` js
var http = require('http');

var server = http.createServer(function(req, res) {
    // 业务逻辑, 等会儿再写.
});

server.listen(3000, function() {
    console.log("静态资源服务器运行中.");
    console.log("正在监听 3000 端口:")
})
```

## url 模块

[url 模块 - 文档](http://nodejs.cn/api/url.html)

有了 HTTP 服务器之后, 我们就可以获取从客户端发过来的 HTTP 请求了.  请求报文中包含着请求 URL. 前文说过, URL 用于定位网络上的资源.  客户端通过 URL 来指明想要的服务器上资源.  那么服务器为了搞清楚客户端到底想要什么, 我们需要处理和解析 URL.  在 Node.js 中, 我们使用 `url` 模块来完成这类操作.

我们知道 URL 字符串是具有结构的字符串，包含多个意义不同的组成部分。 通过 `url.parse()` 函数, URL 字符串可以被解析为一个 URL 对象，其属性对应于字符串的各组成部分。如下图所示.

![Screen Shot 2018-10-05 at 2.18.56 AM](https://i.imgur.com/9ac97ul.png)

---

那么回到我们的静态文件服务器代码.:

先在 `http.createServer` 函数被调用之前, 引入 `url` 模块:

``` js
var url = require('url');
```

然后在 HTTP 服务器里解析请求 URL.  客户端发来的请求 URL 作为属性存放在 `http.createServer` 的回调函数参数所接收的请求对象里, 属性名为 `url`.

``` js
var server = http.createServer(function(req, res) {
    var urlObj = url.parse(req.url);
});
```

## path 模块

[path 模块 - 文档](https://nodejs.org/api/path.html)

接下来从解析后的 URL 对象 `urlObj` 里取得请求 URL 中的路径名(pathname).  路径名保存在 `pathname` 属性里.

``` js
var server = http.createServer(function(req, res) {
    var urlObj = url.parse(req.url);
    var urlPathname = urlObj.pathname;
});
```

但是光有 URL 对象里面的路径名是不够的.  我们还需要获得目标文件在服务器中所在目录的目录名(dirname).

假如说我们的项目结构是下面这样的:

``` bash
.
├── public
│   ├── index.css
│   └── index.html
└── server.js
```

我们的服务器代码写在 `server.js` 文件里.  客户端想要请求保存在 `public` 目录里的 `index.html` 文件.  用户在浏览器中输入 URL 的时候, 他只知道他想要的文件叫 `index.html`, 但这个文件在 HTTP 服务器所在的设备中的 『 绝对位置 』是不被知道的.  所以我们需要让 HTTP 服务器自己去处理这部分操作.

在这里就需要使用 Node.js 自带的 `path` 模块.  其提供了一些工具函数，用于处理文件与目录的路径.  
使用起来很简单, 首先还是在 `http.createServer` 函数被调用之前, 引入 ` path` 模块:

``` js
var path = require('path');
```

之后我们用 `path.join` 这个方法来把 目标文件所在目录的目录名和请求 URL 中的路径名合并起来.  在这个例子中, 客户端可以访问的静态文件全部在 `public` 这个目录中, 而 `public` 目录又在 `server.js` 文件所在的目录中.  `server.js` 中保存的是我们的服务器代码.  想要获得 `server.js` 所在目录的在整个设备中的绝对路径, 我们可以在服务器代码中调用变量 `__dirname`.  其是当前文件在被模块包装器包装时传入的变量, 保存了当前模块的目录名。

``` js
var server = http.createServer(function(req, res) {
    var urlObj = url.parse(req.url);
    var urlPathname = urlObj.pathname;
    var filePathname = path.join(__dirname, "/public", urlPathname);
});
```

如果你想的话, 你可以用 `console.log(filePathname)` 来看看服务器运行后, 从客户端收到的请求 URL 会被转换成什么样.

## fs 模块


[fs 模块 - 文档](http://nodejs.cn/api/fs.html#fs_file_system)

现在来到了最重要的一步, 读取目标文件, 并且返回文件给客户端.  我们需要用 Node.js 自带的 `fs` 模块中的 `fs.write` 方法来实现这一步.  该方法第一个参数为目标文件的路径, 最后一个参数为一个回调函数, 回调有两个参数 (err, data)，其中 `data` 是文件的内容, 如果发生错误的话 `err` 保存错误信息.  `fs.write` 方法可以在第二个参数中指定字符编码, 如果未指定则返回原始的 buffer.  在这个例子中, 我们不考虑这一项.

那么具体代码如下:

首先引入 `fs` 模块, 我就不赘述了, 参照前面就可以了.  下面是读取文件的代码.

``` js
var server = http.createServer(function(req, res) {
    var urlObj = url.parse(req.url);
    var urlPathname = urlObj.pathname;
    var filePathname = path.join(__dirname, "/public", urlPathname);
    
    fs.readFile(filePathname, (err, data) => {
        // 如果有问题返回 404
        if (err) {
            res.writeHead(404);
            res.write("404 - File is not found!");
            res.end();
        // 没问题返回文件内容
        } else {
            res.writeHead(200);
            res.write(data);
            res.end();
        }
    })
});
```

现在我们就实现了一个基本的『 静态文件服务器 』可以在允许客户端请求保存在服务器中公开的静态文件了.  你可以尝试启动服务器, 然后让浏览器中访问 `http://localhost:3000/index.html`.  我的效果如下:

![Screen Shot 2018-10-06 at 2.22.08 PM](https://i.imgur.com/hWu58TA.png)

## 完整代码

作为参考, 我的完整代码如下:

``` js
var http = require('http');
var url = require('url');
var path = require('path');
var fs = require('fs');

var server = http.createServer(function(req, res) {
    var urlObj = url.parse(req.url);
    var urlPathname = urlObj.pathname;
    var filePathname = path.join(__dirname, "/public", urlPathname);

    fs.readFile(filePathname, (err, data) => {
        if (err) {
            res.writeHead(404);
            res.write("404 - File is not found!");
            res.end();
        } else {
            res.writeHead(200);
            res.write(data);
            res.end();
        }
    })

});

server.listen(3000, function() {
    console.log("静态资源服务器运行中.");
    console.log("正在监听 3000 端口:")
})
```